# 计算机图形学项目个人报告

**16340013-曾翔**

在本项目中我主要负责的是光照与阴影。

### 光照

在项目中使用的是Phone光照模型。

```
vec3 ambient = light.ambient * Diffuse.rgb;
  	
    // diffuse 
    vec3 norm = normalize(Normal);
    vec3 lightDir = normalize(light.position - FragPos);
    float diff = max(dot(norm, lightDir), 0.0);
    vec3 diffuse =light.diffuse * diff *Diffuse.rgb;  
      
    // attenuation
    float distance    = length(light.position - FragPos);
    float attenuation = 1.0 / (light.constant + light.linear * distance + light.quadratic * (distance * distance));    
	// specular
    vec3 viewDir = normalize(viewPos - FragPos);
    vec3 reflectDir = reflect(-lightDir, norm);  
    float spec = pow(max(dot(viewDir, reflectDir), 0.0), shininess);
    vec3 specular = light.specular * spec *   Specular.rgb;  
```

效果图如下：

![1563558047747](C:\Users\25755\AppData\Roaming\Typora\typora-user-images\1563558047747.png)

### 阴影

阴影映射的实现首先根据光照判断出阴影部分并进行渲染获得深度贴图，然后在实际渲染中将位于阴影中的部分的漫反射与镜面反射去除。

```
 shadowShader = Shader("Shadow.vs", "Shadow.fs");


    glGenTextures(1, &depthMap);
    glGenFramebuffers(1, &depthMapFBO);
    glBindTexture(GL_TEXTURE_2D, depthMap);
    glTexImage2D(GL_TEXTURE_2D, 0, GL_DEPTH_COMPONENT,
                 width, height, 0, GL_DEPTH_COMPONENT, GL_FLOAT, nullptr);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_BORDER);
    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_BORDER);
    GLfloat borderColor[] = {1.0, 1.0, 1.0, 1.0};
    glTexParameterfv(GL_TEXTURE_2D, GL_TEXTURE_BORDER_COLOR, borderColor);

    glBindFramebuffer(GL_FRAMEBUFFER, depthMapFBO);
    glFramebufferTexture2D(GL_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_TEXTURE_2D, depthMap, 0);
    glDrawBuffer(GL_NONE);
    glReadBuffer(GL_NONE);
    glBindFramebuffer(GL_FRAMEBUFFER, 0);
```

同时在着色器中使用了阴影偏移和 PCF 来改良阴影效果：

```
float bias = max(0.05 * (1.0 - dot(normal, lightDir)), 0.005);
    // check whether current frag pos is in shadow
    // float shadow = currentDepth - bias > closestDepth  ? 1.0 : 0.0;
    // PCF
    float shadow = 0.0;
    vec2 texelSize = 1.0 / textureSize(shadowMap, 0);
    for(int x = -1; x <= 1; ++x)
    {
        for(int y = -1; y <= 1; ++y)
        {
            float pcfDepth = texture(shadowMap, projCoords.xy + vec2(x, y) * texelSize).r; 
            shadow += currentDepth - bias > pcfDepth  ? 1.0 : 0.0;        
        }    
    }
    shadow /= 9.0;
```

最终获得的阴影效果如下图：

![1563558080091](C:\Users\25755\AppData\Roaming\Typora\typora-user-images\1563558080091.png)

### 个人感想

这次的作业我所负责的部分虽然是基础部分，几乎都是上课讲过的内容，但是由于在学习相关内容的时候并没能完全的掌握，所以在世纪过程中还是遇到了很多的问题，在遇到这些问题的时候我回去复习了上课讲过的内容，并且得到了我的队友的帮助，以此在更了解原理之后把之前遇到的问题算是比较好的解决了。项目的完成多亏了小组每一位成员的努力，在此致以由衷的感谢。

